# Story 5.1: Journey Comparison Analysis

## Status
Draft

## Story
**As an admin,**
**I want** side-by-side comparison of successful vs failed journeys,
**so that** I can understand specific factors that drive conversion differences.

## Acceptance Criteria
1. Visual journey comparison with highlighted differences in successful vs failed paths
2. Content diff analysis showing specific changes between journey versions
3. Timing comparison for engagement pattern analysis
4. Hypothesis comparison with outcome correlation data
5. Statistical significance testing for journey performance differences

**Integration Verification:**
- IV1: Existing journey viewing functionality maintained with comparison overlay
- IV2: Current data visualization performance preserved with advanced comparisons
- IV3: Journey loading times remain under 3 seconds for comparison views

## Tasks / Subtasks

- [ ] **Task 1: Journey Comparison Data Infrastructure** (AC: 1, 2)
  - [ ] Design journey comparison data model with successful vs failed journey pairing
  - [ ] Implement journey selection and filtering system for comparison analysis
  - [ ] Create content version diff analysis algorithms for detecting changes between journeys
  - [ ] Build journey path mapping with page-to-page transition tracking
  - [ ] Add statistical significance calculations for journey performance differences
  - [ ] **Files**: `/lib/data-models/journey-comparison-models.ts`, `/lib/journey-analytics/comparison-engine.ts`
  - [ ] **Tests**: Journey pairing accuracy, content diff detection validation
  - [ ] **Integration**: Leverages existing journey analytics infrastructure from Story 4.2

- [ ] **Task 2: Content Diff Analysis Engine** (AC: 2)
  - [ ] Implement content version comparison algorithms with semantic analysis
  - [ ] Create content change categorization (text changes, structural changes, element additions/removals)
  - [ ] Build content similarity scoring using existing ContentElementParser patterns
  - [ ] Add hypothesis correlation with content changes for outcome analysis
  - [ ] Create content diff visualization data structures for UI rendering
  - [ ] **Files**: `/lib/content-analysis/content-diff-engine.ts`, `/lib/content-analysis/change-categorization.ts`
  - [ ] **Tests**: Content diff accuracy, similarity scoring validation
  - [ ] **Integration**: Extends Story 4.1 ContentElementParser infrastructure with comparison capabilities

- [ ] **Task 3: Timing and Engagement Comparison Analytics** (AC: 3)
  - [ ] Build timing comparison algorithms for page-level engagement analysis
  - [ ] Implement engagement pattern analysis comparing successful vs failed journeys
  - [ ] Create time-on-page differential analysis with statistical significance testing
  - [ ] Add engagement score comparison with confidence intervals
  - [ ] Build timing visualization data structures for comparison charts
  - [ ] **Files**: `/lib/journey-analytics/timing-comparison.ts`, `/lib/analytics/engagement-differential.ts`
  - [ ] **Tests**: Timing analysis accuracy, engagement pattern detection validation
  - [ ] **Integration**: Extends Story 4.2 time analytics with comparison capabilities

- [ ] **Task 4: Hypothesis Outcome Correlation Engine** (AC: 4, 5)
  - [ ] Create hypothesis comparison system linking content versions to outcomes
  - [ ] Implement outcome correlation analysis with statistical significance testing
  - [ ] Build hypothesis effectiveness scoring comparing successful vs failed journeys
  - [ ] Add Wilson confidence intervals for hypothesis outcome comparisons
  - [ ] Create predictive correlation models for hypothesis success probability
  - [ ] **Files**: `/lib/hypothesis-analytics/correlation-engine.ts`, `/lib/statistics/outcome-analysis.ts`
  - [ ] **Tests**: Correlation accuracy, statistical significance validation
  - [ ] **Integration**: Leverages existing PatternDetectionEngine from Story 4.1 for statistical analysis

- [ ] **Task 5: Journey Comparison Dashboard** (AC: 1, 3, 4, 5)
  - [ ] Create journey comparison selection interface with filtering and search
  - [ ] Build side-by-side journey visualization with highlighted differences
  - [ ] Implement content diff display with change highlighting and categorization
  - [ ] Add timing comparison charts with engagement pattern analysis
  - [ ] Create hypothesis outcome correlation visualization with confidence intervals
  - [ ] **Files**: `/app/dashboard/journey-comparison/page.tsx`, `/components/dashboard/JourneyComparison.tsx`, `/components/dashboard/ContentDiffVisualization.tsx`
  - [ ] **Tests**: Dashboard functionality, comparison visualization accuracy
  - [ ] **Integration**: Extends Story 4.2 journey analytics dashboard with comparison views

- [ ] **Task 6: Statistical Analysis and Performance Optimization** (AC: 5, IV3)
  - [ ] Implement statistical significance testing for all journey comparisons
  - [ ] Build performance-optimized comparison algorithms for sub-3-second loading
  - [ ] Create comparison result caching system with intelligent invalidation
  - [ ] Add background processing for complex comparison calculations
  - [ ] Implement progressive loading for large journey comparison datasets
  - [ ] **Files**: `/lib/statistics/significance-testing.ts`, `/lib/performance/comparison-optimization.ts`
  - [ ] **Tests**: Statistical accuracy, performance benchmarking under 3 seconds
  - [ ] **Integration**: Uses existing background processing patterns from Story 4.2

## Dev Notes

### Architecture Context
Story 5.1 builds upon the comprehensive journey analytics infrastructure established in Epic 4, specifically extending the pattern recognition and journey flow analysis capabilities to enable direct comparison between successful and failed client journeys. This story creates sophisticated comparison algorithms that enable admins to identify the specific content, timing, and engagement factors that differentiate successful conversions from failed attempts.

### Previous Story Dependencies & Integration Strategy

**Epic 4.2 Foundation (Drop-off Point Analysis):**
- **JourneySession and JourneyPageVisit Models**: Complete journey tracking infrastructure with timing, engagement, and exit analysis
  - Location: `/lib/data-models/journey-models.ts`
  - Integration: EXTEND with comparison-specific fields and pairing algorithms
  - Enhancement: Add journey comparison metadata, success/failure pairing, statistical analysis fields

- **DropOffDetectionEngine**: Statistical pattern detection with Wilson confidence intervals and significance testing
  - Location: `/lib/journey-analytics/drop-off-engine.ts`
  - Integration: REUSE statistical analysis patterns for journey comparison significance testing
  - Enhancement: Apply same statistical rigor to comparison analysis algorithms

- **JourneyFlow and Analytics Dashboard**: Interactive visualization with funnel charts, journey maps, and real-time metrics
  - Location: `/components/dashboard/JourneyFlow.tsx`, `/app/dashboard/journey-analytics/page.tsx`
  - Integration: EXTEND with comparison views and side-by-side visualization
  - Enhancement: Add comparison overlay modes, difference highlighting, correlation displays

**Epic 4.1 Foundation (Pattern Recognition):**
- **PatternDetectionEngine**: Statistical pattern identification with confidence scoring and clustering
  - Location: `/lib/pattern-recognition/detection-engine.ts`
  - Integration: REUSE for journey comparison pattern analysis and outcome correlation
  - Enhancement: Apply pattern detection to identify consistent differences between successful/failed journeys

- **ContentElementParser**: Content analysis with NLP-style similarity matching for content correlation
  - Location: `/lib/content-analysis/element-parser.ts`
  - Integration: LEVERAGE for content diff analysis and version comparison
  - Enhancement: Extend with semantic content comparison and change categorization

### Core Technical Components

**Journey Comparison Data Models:**
```typescript
interface JourneyComparison {
  id: string;
  successfulJourneyId: string;
  failedJourneyId: string;
  comparisonType: 'content_focused' | 'timing_focused' | 'engagement_focused' | 'comprehensive';
  successfulJourney: JourneySession;
  failedJourney: JourneySession;
  contentDifferences: ContentDiff[];
  timingDifferences: TimingDiff[];
  engagementDifferences: EngagementDiff[];
  hypothesisCorrelations: HypothesisCorrelation[];
  statisticalSignificance: StatisticalAnalysis;
  confidenceScore: number;
  createdAt: Date;
}

interface ContentDiff {
  pageType: 'activation' | 'agreement' | 'confirmation' | 'processing';
  changeType: 'text_change' | 'structural_change' | 'element_addition' | 'element_removal';
  successfulContent: ContentVersion;
  failedContent: ContentVersion;
  diffDetails: DiffDetail[];
  impactScore: number; // How significant this difference is
  correlationStrength: number; // How much this change correlates with outcome
}

interface TimingDiff {
  pageType: string;
  successfulTiming: TimingAnalysis;
  failedTiming: TimingAnalysis;
  timeDifferential: number; // seconds difference
  engagementDifferential: number; // engagement score difference
  statisticalSignificance: number; // p-value
}

interface HypothesisCorrelation {
  hypothesisId: string;
  hypothesis: string;
  successfulOutcome: boolean;
  failedOutcome: boolean;
  correlationStrength: number;
  confidenceInterval: [number, number];
  sampleSize: number;
}
```
[Source: architecture/data-models-and-schema-changes.md#content-versions-model]

**Content Diff Analysis Engine:**
```typescript
export class ContentDiffEngine {
  async compareJourneyContent(
    successfulJourney: JourneySession,
    failedJourney: JourneySession
  ): Promise<ContentDiff[]> {
    const diffs: ContentDiff[] = [];
    
    // Compare content versions for each page type
    for (const pageType of ['activation', 'agreement', 'confirmation', 'processing']) {
      const successfulPage = successfulJourney.pageVisits.find(p => p.pageType === pageType);
      const failedPage = failedJourney.pageVisits.find(p => p.pageType === pageType);
      
      if (successfulPage && failedPage) {
        const contentDiff = await this.analyzeContentDifference(
          successfulPage.contentVersionId,
          failedPage.contentVersionId,
          pageType
        );
        
        if (contentDiff.diffDetails.length > 0) {
          diffs.push(contentDiff);
        }
      }
    }
    
    return diffs.sort((a, b) => b.impactScore - a.impactScore);
  }

  private async analyzeContentDifference(
    successfulVersionId: string,
    failedVersionId: string,
    pageType: string
  ): Promise<ContentDiff> {
    const successfulContent = await this.getContentVersion(successfulVersionId);
    const failedContent = await this.getContentVersion(failedVersionId);
    
    // Use ContentElementParser for semantic analysis
    const semanticDiff = await this.contentElementParser.compareVersions(
      successfulContent,
      failedContent
    );
    
    // Calculate impact and correlation scores
    const impactScore = this.calculateContentImpactScore(semanticDiff);
    const correlationStrength = await this.calculateOutcomeCorrelation(
      successfulContent,
      failedContent
    );
    
    return {
      pageType,
      changeType: this.categorizeChangeType(semanticDiff),
      successfulContent,
      failedContent,
      diffDetails: semanticDiff,
      impactScore,
      correlationStrength
    };
  }
}
```
[Source: architecture/component-architecture.md#content-element-parser]

**Statistical Journey Comparison:**
```typescript
export class JourneyComparisonStatistics {
  async calculateComparisonSignificance(
    comparison: JourneyComparison
  ): Promise<StatisticalAnalysis> {
    const { successfulJourney, failedJourney } = comparison;
    
    // Apply Wilson confidence intervals (established in Story 4.1)
    const timingSignificance = await this.calculateTimingSignificance(
      successfulJourney,
      failedJourney
    );
    
    const engagementSignificance = await this.calculateEngagementSignificance(
      successfulJourney,
      failedJourney
    );
    
    const contentSignificance = await this.calculateContentSignificance(
      comparison.contentDifferences
    );
    
    // Combined significance score using Fisher's method
    const combinedPValue = this.combineSignificanceTests([
      timingSignificance.pValue,
      engagementSignificance.pValue,
      contentSignificance.pValue
    ]);
    
    return {
      overallSignificance: combinedPValue,
      timingSignificance,
      engagementSignificance,
      contentSignificance,
      confidenceLevel: combinedPValue < 0.05 ? 'high' : combinedPValue < 0.1 ? 'medium' : 'low',
      sampleSize: this.calculateEffectiveSampleSize(comparison)
    };
  }

  private async calculateTimingSignificance(
    successful: JourneySession,
    failed: JourneySession
  ): Promise<TimingSignificance> {
    // Apply same statistical rigor as DropOffDetectionEngine
    const successfulTimings = successful.pageVisits.map(p => p.timeOnPage);
    const failedTimings = failed.pageVisits.map(p => p.timeOnPage);
    
    return this.performWelchsTTest(successfulTimings, failedTimings);
  }
}
```
[Source: architecture/component-architecture.md#pattern-detection-engine]

### Required Database Schema Extensions

**Journey Comparison Tables:**
```sql
CREATE TABLE journey_comparisons (
  id VARCHAR(191) PRIMARY KEY,
  successful_journey_id VARCHAR(191) NOT NULL,
  failed_journey_id VARCHAR(191) NOT NULL,
  comparison_type ENUM('content_focused', 'timing_focused', 'engagement_focused', 'comprehensive') DEFAULT 'comprehensive',
  confidence_score DECIMAL(3,2) NOT NULL,
  statistical_significance DECIMAL(10,8), -- p-value
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by TEXT DEFAULT 'admin',
  
  INDEX idx_successful_journey (successful_journey_id),
  INDEX idx_failed_journey (failed_journey_id),
  INDEX idx_confidence_score (confidence_score DESC),
  FOREIGN KEY (successful_journey_id) REFERENCES journey_sessions(id) ON DELETE CASCADE,
  FOREIGN KEY (failed_journey_id) REFERENCES journey_sessions(id) ON DELETE CASCADE
);

CREATE TABLE content_diffs (
  id VARCHAR(191) PRIMARY KEY,
  comparison_id VARCHAR(191) NOT NULL,
  page_type ENUM('activation', 'agreement', 'confirmation', 'processing') NOT NULL,
  change_type ENUM('text_change', 'structural_change', 'element_addition', 'element_removal') NOT NULL,
  successful_content_id VARCHAR(191) NOT NULL,
  failed_content_id VARCHAR(191) NOT NULL,
  diff_details JSON NOT NULL,
  impact_score DECIMAL(3,2) NOT NULL,
  correlation_strength DECIMAL(3,2) NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_comparison_id (comparison_id),
  INDEX idx_impact_score (impact_score DESC),
  FOREIGN KEY (comparison_id) REFERENCES journey_comparisons(id) ON DELETE CASCADE,
  FOREIGN KEY (successful_content_id) REFERENCES content_versions(id),
  FOREIGN KEY (failed_content_id) REFERENCES content_versions(id)
);

CREATE TABLE hypothesis_correlations (
  id VARCHAR(191) PRIMARY KEY,
  comparison_id VARCHAR(191) NOT NULL,
  successful_hypothesis TEXT NOT NULL,
  failed_hypothesis TEXT NOT NULL,
  correlation_strength DECIMAL(3,2) NOT NULL,
  confidence_interval_lower DECIMAL(3,2),
  confidence_interval_upper DECIMAL(3,2),
  sample_size INTEGER NOT NULL,
  statistical_significance DECIMAL(10,8), -- p-value
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_comparison_id (comparison_id),
  INDEX idx_correlation_strength (correlation_strength DESC),
  FOREIGN KEY (comparison_id) REFERENCES journey_comparisons(id) ON DELETE CASCADE
);
```

### Integration with Epic 4 Infrastructure

**Leveraging Journey Analytics Foundation:**
- **Journey Sessions Data**: Reuse existing session tracking with comparison metadata
- **Real-time Processing**: Apply same event-driven architecture for comparison calculations
- **Statistical Analysis**: Extend Wilson confidence intervals and p-value calculations to comparison analysis
- **Background Jobs**: Use existing processing queue for complex comparison calculations

**Leveraging Pattern Recognition Infrastructure:**
- **Content Analysis**: Extend ContentElementParser with semantic comparison capabilities
- **Statistical Rigor**: Apply same significance testing patterns to journey comparisons
- **Visualization Components**: Extend PatternVisualization with comparison overlay modes
- **Database Integration**: Link to existing pattern infrastructure for correlation analysis

**Performance Optimization Strategy:**
- **Caching**: Smart comparison result caching with invalidation on new journey data
- **Progressive Loading**: Load comparison analysis incrementally for large datasets
- **Background Processing**: Complex statistical calculations processed asynchronously
- **Query Optimization**: Indexed queries for sub-3-second comparison loading (IV3)

### File Structure & Integration Points

**New Files:**
- `/lib/data-models/journey-comparison-models.ts` - TypeScript interfaces for journey comparison
- `/lib/journey-analytics/comparison-engine.ts` - Core comparison algorithms and journey pairing
- `/lib/content-analysis/content-diff-engine.ts` - Content version comparison and diff analysis
- `/lib/content-analysis/change-categorization.ts` - Content change type classification
- `/lib/journey-analytics/timing-comparison.ts` - Timing and engagement differential analysis
- `/lib/analytics/engagement-differential.ts` - Engagement pattern comparison algorithms
- `/lib/hypothesis-analytics/correlation-engine.ts` - Hypothesis outcome correlation analysis
- `/lib/statistics/outcome-analysis.ts` - Statistical significance testing for outcomes
- `/lib/statistics/significance-testing.ts` - Statistical significance testing utilities
- `/lib/performance/comparison-optimization.ts` - Performance optimization for comparison operations
- `/app/dashboard/journey-comparison/page.tsx` - Journey comparison dashboard page
- `/components/dashboard/JourneyComparison.tsx` - Main journey comparison visualization component
- `/components/dashboard/ContentDiffVisualization.tsx` - Content difference display component
- `/supabase/migrations/006-journey-comparison-schema.sql` - Database schema for comparison analysis

**Enhanced Files:**
- `/app/dashboard/journey-analytics/page.tsx` - Add comparison analysis tab
- `/lib/journey-analytics/drop-off-engine.ts` - Extend with comparison analysis methods
- `/lib/pattern-recognition/detection-engine.ts` - Add journey comparison pattern detection
- `/components/dashboard/JourneyFlow.tsx` - Add comparison overlay visualization modes

## Testing

### Testing Standards
**Test Framework:** Playwright MCP for browser automation and end-to-end testing
**Test Location:** `/tests/story-5-1-journey-comparison-analysis.spec.ts`
**Coverage Requirements:** 95% for comparison algorithms, 90% for dashboard functionality, 100% for statistical significance calculations

**Key Testing Areas:**
1. **Journey Comparison Accuracy** - Validation of journey pairing and comparison algorithms
2. **Content Diff Detection** - Verification of content difference identification and categorization
3. **Statistical Analysis** - Testing of significance calculations and confidence intervals
4. **Dashboard Functionality** - Journey comparison visualization and interaction testing
5. **Performance Validation** - Sub-3-second loading for comparison views (IV3)
6. **Integration Testing** - Compatibility with existing journey analytics infrastructure (IV1, IV2)

**Performance Benchmarks:**
- Journey comparison data loading: < 3 seconds for comparison views (IV3)
- Content diff analysis: < 2 seconds for content version comparison
- Statistical significance calculations: < 1 second for hypothesis correlation analysis
- Dashboard rendering: < 2 seconds for comparison visualization with up to 50 journey pairs

## Previous Story Learnings

### Epic 4.2 Foundation (Drop-off Point Analysis)
**Established Infrastructure to Leverage:**
- **Journey Analytics Database Schema**: 3-table comprehensive system (journey_sessions, journey_page_visits, drop_off_patterns)
  - **Integration**: EXTEND with comparison tables linking to existing journey infrastructure
  - **Reuse**: Session tracking, page visit analysis, timing calculations, engagement scoring
  - **Enhancement**: Add comparison metadata and correlation fields to existing data models

- **Statistical Analysis Engine**: Wilson confidence intervals, p-value calculations, significance testing
  - **Integration**: APPLY same statistical rigor to journey comparison analysis
  - **Reuse**: Significance testing patterns, confidence interval calculations, sample size validations
  - **Enhancement**: Extend statistical methods for comparison analysis and correlation testing

- **Real-time Analytics**: Event-driven processing with sub-5-second updates, background job processing
  - **Integration**: USE same architecture for comparison calculations and result caching
  - **Reuse**: Background processing queue, cache invalidation, event-driven updates
  - **Enhancement**: Comparison-specific event types and processing workflows

- **Dashboard Visualization**: Interactive funnel charts, journey maps, time analysis with expandable cards
  - **Integration**: EXTEND with comparison overlay modes and side-by-side visualization
  - **Reuse**: Chart components, interactive navigation, expandable card patterns
  - **Enhancement**: Comparison highlighting, difference visualization, correlation displays

### Epic 4.1 Foundation (Pattern Recognition)
**Core Components for Content Analysis:**
- **ContentElementParser**: NLP-style similarity matching with performance tracking
  - **Integration**: EXTEND for semantic content comparison and change detection
  - **Reuse**: Content similarity algorithms, element extraction, performance optimization
  - **Enhancement**: Content diff analysis, change categorization, impact scoring

- **PatternDetectionEngine**: Advanced statistical pattern identification with clustering
  - **Integration**: APPLY to journey comparison pattern analysis and outcome correlation
  - **Reuse**: Pattern clustering, confidence scoring, statistical significance calculation
  - **Enhancement**: Journey-specific pattern types for successful vs failed comparison analysis

**Architecture Decisions to Follow:**
- **Component Modularity**: Build reusable comparison components for future Epic 5 enhancements
- **Statistical Excellence**: Maintain same rigor with Wilson confidence intervals and proper significance testing
- **Event-driven Architecture**: Use background processing + caching for optimal comparison performance
- **Database Optimization**: Apply proven indexing and query optimization patterns from previous stories

**Performance Patterns Proven Successful:**
- Background processing + intelligent caching + progressive loading = sub-3-second performance
- Interactive visualization with expandable details for complex comparison data display
- Real-time updates without blocking UI through event-driven architecture
- Statistical analysis + caching + background computation = comprehensive analysis with fast user experience

### Epic 1-3 Infrastructure Integration
**Client Journey Foundation:**
- 4-page journey structure provides clear comparison points across activation → agreement → confirmation → processing
- Content versioning system enables precise content diff analysis between successful and failed journeys
- Learning capture system (hypothesis, outcome, iteration notes) provides rich correlation data for comparison analysis

**Data Layer Integration:**
- Existing content_versions table provides foundation for content diff analysis
- Journey tracking from Epic 4.2 provides timing and engagement data for comparison
- Payment correlation data enables precise success/failure journey identification for comparison pairing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | Initial story creation for Epic 5.1 Journey Comparison Analysis | SM Agent (Bob) |